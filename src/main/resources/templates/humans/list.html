<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ru" th:replace="fragments/layout :: layout(~{::title}, ~{::section})">
<head>
    <title>Люди</title>
</head>
<body>
<section>
    <div class="alerts">
        <div th:if="${success}" class="alert alert-success" th:text="${success}"></div>
        <div th:if="${actionError}" class="alert alert-error" th:text="${actionError}"></div>
    </div>
    <div class="summary">
        <span>Всего людей: <strong id="human-count" th:text="${humans.totalElements}"></strong></span>
        <span>Суммарная скорость: <strong id="impact-sum" th:text="${sumImpactSpeed}"></strong></span>
    </div>
    <div class="actions-grid">
        <div class="action-card">
            <h3>Импорт из JSON</h3>
            <form id="import-form" th:attr="data-endpoint=${importEndpoint}" enctype="multipart/form-data">
                <div class="form-field">
                    <label for="importFile">Файл</label>
                    <input id="importFile" type="file" name="file" accept="application/json">
                </div>
                <div class="form-actions">
                    <button type="submit">Загрузить</button>
                    <button type="button" class="button secondary" data-import-help>Описание формата</button>
                </div>
            </form>
            <div class="action-results">
                <div id="import-success" class="alert alert-success" hidden></div>
                <div id="import-error" class="alert alert-error" hidden></div>
            </div>
        </div>
        <div class="action-card">
            <h3>Массовая смена настроения</h3>
            <form th:action="@{/humans/actions/change-mood}" th:object="${moodChangeRequest}" method="post">
                <div class="form-field" th:classappend="${#fields.hasErrors('sourceMood')} ? ' has-error'">
                    <label for="sourceMood">Текущее настроение</label>
                    <select id="sourceMood" th:field="*{sourceMood}">
                        <option value="">—</option>
                        <option th:each="m : ${moods}" th:value="${m}" th:text="${m}"></option>
                    </select>
                    <div class="error" th:if="${#fields.hasErrors('sourceMood')}" th:errors="*{sourceMood}"></div>
                </div>
                <div class="form-field" th:classappend="${#fields.hasErrors('targetMood')} ? ' has-error'">
                    <label for="targetMood">Новое настроение</label>
                    <select id="targetMood" th:field="*{targetMood}">
                        <option value="">—</option>
                        <option th:each="m : ${moods}" th:value="${m}" th:text="${m}"></option>
                    </select>
                    <div class="error" th:if="${#fields.hasErrors('targetMood')}" th:errors="*{targetMood}"></div>
                </div>
                <div class="form-actions">
                    <button type="submit">Изменить</button>
                </div>
            </form>
        </div>
        <div class="action-card">
            <h3>Быстрые операции</h3>
            <div class="action-buttons">
                <form th:action="@{/humans/actions/make-gloom}" method="post">
                    <button type="submit" class="button secondary">Сделать всех gloomy</button>
                </form>
                <form th:action="@{/humans/actions/assign-default-car}" method="post">
                    <button type="submit">Назначить автомобиль</button>
                </form>
            </div>
        </div>
        <div class="action-card">
            <h3>Счётчик по скорости</h3>
            <form th:action="@{/humans/actions/count-impact}" th:object="${impactSpeedRequest}" method="post">
                <div class="form-field" th:classappend="${#fields.hasErrors('threshold')} ? ' has-error'">
                    <label for="threshold">Порог скорости</label>
                    <input id="threshold" type="number" min="1" max="907" th:field="*{threshold}">
                    <div class="error" th:if="${#fields.hasErrors('threshold')}" th:errors="*{threshold}"></div>
                </div>
                <div class="form-actions">
                    <button type="submit">Рассчитать</button>
                </div>
            </form>
            <div class="action-results" th:if="${impactSpeedCount != null}">
                <span>Людей со скоростью ниже порога: <strong th:text="${impactSpeedCount}"></strong></span>
            </div>
        </div>
        <div class="action-card">
            <h3>Поиск саундтреков</h3>
            <form th:action="@{/humans/actions/search-soundtrack}" th:object="${soundtrackSearchRequest}" method="post">
                <div class="form-field" th:classappend="${#fields.hasErrors('prefix')} ? ' has-error'">
                    <label for="soundtrackPrefixInput">Префикс</label>
                    <input id="soundtrackPrefixInput" type="text" th:field="*{prefix}">
                    <div class="error" th:if="${#fields.hasErrors('prefix')}" th:errors="*{prefix}"></div>
                </div>
                <div class="form-actions">
                    <button type="submit">Найти</button>
                </div>
            </form>
            <div class="action-results" th:if="${soundtrackMatches != null}">
                <ul class="action-list" th:if="${!#lists.isEmpty(soundtrackMatches)}">
                    <li th:each="human : ${soundtrackMatches}">
                        <span th:text="${human.name}"></span>
                        <small th:text="${human.soundtrackName}"></small>
                    </li>
                </ul>
                <div th:if="${#lists.isEmpty(soundtrackMatches)}">Нет совпадений</div>
            </div>
        </div>
    </div>
    <div class="history-card" id="import-history"
         th:attr="data-endpoint=${importHistoryEndpoint},data-admin=${historyIsAdmin}"
         th:if="${importHistory != null}">
        <div class="history-header">
            <h3>История импорта</h3>
            <div class="history-meta">
                <span th:if="${!historyIsAdmin}" th:text="${'Пользователь: ' + historyUsername}"></span>
                <button type="button" class="button secondary" data-history-reload>Обновить</button>
            </div>
        </div>
        <table class="data-table history-table">
            <thead>
            <tr>
                <th>ID</th>
                <th th:if="${historyIsAdmin}">Инициатор</th>
                <th>Статус</th>
                <th>Добавлено</th>
                <th>Сообщение</th>
                <th>Обновлено</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="operation : ${importHistory.content}">
                <td th:text="${operation.id}"></td>
                <td th:if="${historyIsAdmin}" th:text="${operation.initiator}"></td>
                <td th:text="${operation.status}"></td>
                <td th:text="${operation.addedCount != null ? operation.addedCount : '—'}"></td>
                <td th:text="${operation.errorMessage != null ? operation.errorMessage : '—'}"></td>
                <td th:text="${operation.updatedAt}"></td>
            </tr>
            <tr th:if="${importHistory.content.isEmpty()}" data-history-empty>
                <td th:attr="colspan=${historyIsAdmin ? 6 : 5}" class="empty">Операций пока нет</td>
            </tr>
            </tbody>
        </table>
    </div>
    <div id="import-help-content" hidden>
        <h4>Формат файла</h4>
        <p>Импорт ожидает JSON-файл с массивом записей о людях. Каждая запись должна содержать следующий набор полей:</p>
        <ul>
            <li><strong>name</strong> — обязательная строка длиной до 255 символов.</li>
            <li><strong>coordinates</strong> — объект с координатами:
                <ul>
                    <li><strong>x</strong> — обязательное целое число.</li>
                    <li><strong>y</strong> — обязательное неотрицательное число с плавающей точкой.</li>
                </ul>
            </li>
            <li><strong>realHero</strong> — обязательное логическое значение.</li>
            <li><strong>hasToothpick</strong> — обязательное логическое значение.</li>
            <li><strong>impactSpeed</strong> — обязательное целое число &gt; 0 и ≤ 907.</li>
            <li><strong>soundtrackName</strong> — обязательная строка длиной до 255 символов.</li>
            <li><strong>weaponType</strong> — обязательная строка со значением одного из перечислений: <code>SHOTGUN</code>, <code>KNIFE</code>, <code>MACHINE_GUN</code>, <code>BAT</code>.</li>
            <li><strong>mood</strong> — обязательная строка со значением одного из перечислений: <code>SADNESS</code>, <code>LONGING</code>, <code>GLOOM</code>.</li>
            <li><strong>car</strong> — объект с данными автомобиля:
                <ul>
                    <li><strong>name</strong> — обязательная строка длиной до 120 символов.</li>
                    <li><strong>cool</strong> — обязательное логическое значение.</li>
                </ul>
            </li>
        </ul>
        <p>Файл должен содержать хотя бы одну запись; неизвестные поля в объектах будут проигнорированы.</p>
    </div>
    <div class="modal-overlay" id="import-help-modal" hidden>
        <div class="modal">
            <div class="modal-header">
                <h3>Описание формата импорта</h3>
                <button type="button" class="button secondary" data-modal-close>&#10005;</button>
            </div>
            <div class="modal-body"></div>
        </div>
    </div>
    <form class="filter-form" method="get">
        <div class="form-grid">
            <label>Имя
                <input type="text" name="name" th:value="${filter.name}">
            </label>
            <label>Минимальная скорость
                <input type="number" min="1" max="907" name="minImpactSpeed" th:value="${filter.minImpactSpeed}">
            </label>
            <label>Максимальная скорость
                <input type="number" min="1" max="907" name="maxImpactSpeed" th:value="${filter.maxImpactSpeed}">
            </label>
            <label>Префикс саундтрека
                <input type="text" name="soundtrackPrefix" th:value="${filter.soundtrackPrefix}">
            </label>
            <label>Настроение
                <select name="mood">
                    <option value="">—</option>
                    <option th:each="m : ${moods}"
                            th:value="${m}"
                            th:selected="${filter.mood} == ${m}"
                            th:text="${m}"></option>
                </select>
            </label>
            <label>Автомобиль
                <select name="carId">
                    <option value="">—</option>
                    <option th:each="car : ${cars}"
                            th:value="${car.id}"
                            th:selected="${filter.carId} == ${car.id}"
                            th:text="${car.name}"></option>
                </select>
            </label>
            <label>Тип оружия
                <select name="weaponType">
                    <option value="">—</option>
                    <option th:each="weapon : ${weaponTypes}"
                            th:value="${weapon}"
                            th:selected="${filter.weaponType} == ${weapon}"
                            th:text="${weapon}"></option>
                </select>
            </label>
            <label>Настоящий герой
                <select name="realHero">
                    <option value="">—</option>
                    <option value="true" th:selected="${filter.realHero} == true">Да</option>
                    <option value="false" th:selected="${filter.realHero} == false">Нет</option>
                </select>
            </label>
            <label>С зубочисткой
                <select name="hasToothpick">
                    <option value="">—</option>
                    <option value="true" th:selected="${filter.hasToothpick} == true">Да</option>
                    <option value="false" th:selected="${filter.hasToothpick} == false">Нет</option>
                </select>
            </label>
        </div>
        <div class="form-actions">
            <button type="submit">Применить</button>
            <a class="button secondary" th:href="@{/humans}">Сбросить</a>
        </div>
    </form>
    <table class="data-table" id="humans-table" data-total-pages="" th:attr="data-total-pages=${humans.totalPages}">
        <thead>
        <tr>
            <th><a th:href="@{|/humans?page=${page}&size=${size}&sort=id&direction=${direction}|}">ID</a></th>
            <th><a th:href="@{|/humans?page=${page}&size=${size}&sort=name&direction=${direction}|}">Имя</a></th>
            <th>Координаты</th>
            <th>Скорость</th>
            <th>Саундтрек</th>
            <th>Оружие</th>
            <th>Настроение</th>
            <th>Герой</th>
            <th>Зубочистка</th>
            <th>Автомобиль</th>
            <th>Действия</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="human : ${humans.content}">
            <td th:text="${human.id}"></td>
            <td th:text="${human.name}"></td>
            <td th:text="${human.coordinates != null ? '(' + human.coordinates.x + '; ' + human.coordinates.y + ')' : '—'}"></td>
            <td th:text="${human.impactSpeed}"></td>
            <td th:text="${human.soundtrackName}"></td>
            <td th:text="${human.weaponType != null ? human.weaponType : '—'}"></td>
            <td th:text="${human.mood != null ? human.mood : '—'}"></td>
            <td th:text="${human.realHero != null ? (human.realHero ? 'Да' : 'Нет') : '—'}"></td>
            <td th:text="${human.hasToothpick ? 'Да' : 'Нет'}"></td>
            <td th:text="${human.car != null ? human.car.name : '—'}"></td>
            <td>
                <a th:href="@{|/humans/${human.id}|}">Просмотр</a>
                <a th:href="@{|/humans/${human.id}/edit|}">Изменить</a>
            </td>
        </tr>
        <tr th:if="${humans.content.isEmpty()}">
            <td colspan="11" class="empty">Нет данных</td>
        </tr>
        </tbody>
    </table>
    <div class="pagination" th:attr="data-page=${page},data-size=${size}">
        <button type="button" class="page-btn" data-direction="prev" th:disabled="${humans.first}">Назад</button>
        <span>Страница <strong th:text="${humans.number + 1}"></strong> из <strong th:text="${humans.totalPages == 0 ? 1 : humans.totalPages}"></strong></span>
        <button type="button" class="page-btn" data-direction="next" th:disabled="${humans.last}">Вперёд</button>
    </div>
</section>
</body>
</html>
