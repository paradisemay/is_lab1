# План нагрузочного тестирования HumanBeing API

Этот план ориентирован на проверку CRUD, конфликтных сценариев и импорта через JMeter 5.6.2. Файлы находятся в каталоге `docs/jmeter`.

## Сценарии

1. **CRUD HumanBeing (20 потоков)** — создание, обновление и удаление записей на `/api/humans` с параметрами из CSV `humans-create.csv` и `humans-update.csv`. ID создаётся и используется в цепочке запроса.
2. **Update vs Delete Conflict (2 потока)** — параллельное обновление и удаление одного `conflictId` (по умолчанию 1) с `Synchronizing Timer` и разветвлением через `Throughput Controller`; ожидается один успешный ответ и один 404.
3. **Duplicate Creation Race (2 потока)** — одновременное создание сущностей с одинаковыми `name+soundtrack` и `realHero+impactSpeed`, используя `humans-duplicates.csv`; проверяются коды 200/400/409 и тексты про уникальность.
4. **Mass Import Overlap (2 потока)** — конкурентный импорт файлов `import-batch-1.json` и `import-batch-2.json` через `/api/humans/import`; ожидаются 200 для успешной пачки и 400/409 при пересечении уникальных ключей.

## Конфигурация

- Общие переменные заданы на уровне Test Plan: `protocol`, `host`, `port`, `basePath`, `threadsMain`, `rampUpSeconds`, `conflictId`.
- `HTTP Header Manager` задаёт `Content-Type: application/json` для JSON-сам플еров; Multipart для импорта задаётся прямо в sampler.
- `CSV Data Set Config` обеспечивает параметры запросов и absolute-пути к файлам импорта (через BeanShell в `import-jobs.csv`).
- Assertions проверяют коды ответов и сообщения об ошибках, особенно для конфликтных сценариев уникальности и удаления.

## Рекомендации по уровню изоляции

- **CRUD (обычные запросы):** достаточно `READ COMMITTED` — операции используют новые ID и не опираются на повторное чтение.
- **Update/Delete на одном ID:** для устойчивого детекта конфликтов и предотвращения фантомов при параллельном чтении/удалении достаточно `REPEATABLE READ`; в наличии жёстких требований по блокировкам можно повышать до `SERIALIZABLE`.
- **Уникальность `name+soundtrack` и `realHero+impactSpeed`:** из-за уникальных индексов и проверок рекомендуется минимум `REPEATABLE READ`, чтобы избежать пропуска конфликтов при гонках; применение `SERIALIZABLE` на критичных сегментах исключает двойные вставки.
- **Импорт:** сервис уже аннотирован `@Transactional(isolation = Isolation.SERIALIZABLE)` — оставляем максимальную изоляцию для массовых вставок и фиксации истории без дублей.

## Запуск

1. Откройте `human-being-test-plan.jmx` в JMeter ≥5.6.2.
2. При необходимости измените переменные Test Plan (`host`, `port`, `conflictId`, размеры Thread Group).
3. Запустите план; для конфликтных сценариев убедитесь, что в базе существует запись с `conflictId` или подготовьте её заранее.
